# ğŸ³ğŸ­ğŸª´ Evolution-Main Branch Makefile
# Production Docker Containerization Workflow

.PHONY: help build up down restart status health logs clean gpu-test evolution-status push-evolution crawler-status crawler-run crawler-stats feeder-status

# Default target
help:
	@echo "ğŸ³ğŸ­ğŸª´ Emotional Tamagotchi Evolution Docker Commands"
	@echo ""
	@echo "ğŸš€ DEPLOYMENT:"
	@echo "  build              Build all Docker images for evolution"
	@echo "  up                 Start the evolution stack"
	@echo "  down               Stop the evolution stack"
	@echo "  restart            Restart the evolution stack"
	@echo ""
	@echo "ğŸ“Š MONITORING:"
	@echo "  status             Show container status"
	@echo "  health             Check all health endpoints"
	@echo "  logs               Show logs from all services"
	@echo "  evolution-status   Show evolution system status"
	@echo ""
	@echo "ğŸ•·ï¸ CRAWLER & FEEDING:"
	@echo "  crawler-status     Check crawler system status"
	@echo "  crawler-run        Run crawler immediately"
	@echo "  crawler-stats      View crawler statistics"
	@echo "  feeder-status      Check auto-feeder status"
	@echo "  feeder-run         Force immediate feeding"
	@echo "  challenge-queue    Show challenge queue status"
	@echo ""
	@echo "ğŸ”§ MAINTENANCE:"
	@echo "  clean              Clean up Docker resources"
	@echo "  gpu-test           Test GPU access in containers"
	@echo "  push-evolution     Push to evolution-main branch"
	@echo ""
	@echo "ğŸ¯ QUICK START:"
	@echo "  make build && make up && make health"

# Build all Docker images
build:
	@echo "ğŸ”¨ Building Evolution Docker Images..."
	docker-compose -f docker-compose.evolution.yml build --parallel
	@echo "âœ… Build complete!"

# Start the evolution stack
up:
	@echo "ğŸš€ Starting Emotional Tamagotchi Evolution Stack..."
	docker-compose -f docker-compose.evolution.yml up -d
	@echo "ğŸ­ Evolution stack started!"
	@echo "ğŸŒ Web UI: http://localhost:5000"
	@echo "ğŸ“Š Grafana: http://localhost:3000"
	@echo "ğŸ“ˆ Prometheus: http://localhost:9091"

# Stop the evolution stack
down:
	@echo "ğŸ›‘ Stopping Evolution Stack..."
	docker-compose -f docker-compose.evolution.yml down
	@echo "âœ… Evolution stack stopped!"

# Restart the evolution stack
restart: down up

# Show container status
status:
	@echo "ğŸ“Š Evolution Container Status:"
	docker-compose -f docker-compose.evolution.yml ps
	@echo ""
	@echo "ğŸ³ Docker System Info:"
	docker system df

# Check all health endpoints
health:
	@echo "ğŸ¥ Checking Evolution Health Endpoints..."
	@echo ""
	@echo "ğŸ§  Swarm API Health:"
	@curl -f http://localhost:8000/health || echo "âŒ Swarm API unhealthy"
	@curl -f http://localhost:8000/health/logic_god || echo "âŒ Logic God unhealthy"
	@echo ""
	@echo "ğŸ”¥ Trainer Health:"
	@docker-compose -f docker-compose.evolution.yml exec -T trainer python3 -c "import psutil; print('âœ… Trainer healthy' if any('trainer_worker' in p.name() for p in psutil.process_iter()) else 'âŒ Trainer unhealthy')" || echo "âŒ Trainer container unreachable"
	@echo ""
	@echo "ğŸ­ Scheduler Health:"
	@curl -f http://localhost:8081/health || echo "âŒ Scheduler unhealthy"
	@echo ""
	@echo "ğŸ“Š Prometheus Health:"
	@curl -f http://localhost:9091/-/healthy || echo "âŒ Prometheus unhealthy"
	@echo ""
	@echo "ğŸ“ˆ Grafana Health:"
	@curl -f http://localhost:3000/api/health || echo "âŒ Grafana unhealthy"
	@echo ""
	@echo "ğŸŒ Web UI Health:"
	@curl -f http://localhost:5000/api/status || echo "âŒ Web UI unhealthy"

# Show logs from all services
logs:
	@echo "ğŸ“‹ Evolution Stack Logs:"
	docker-compose -f docker-compose.evolution.yml logs --tail=50

# Show logs for specific service
logs-api:
	docker-compose -f docker-compose.evolution.yml logs -f swarm-api

logs-trainer:
	docker-compose -f docker-compose.evolution.yml logs -f trainer

logs-scheduler:
	docker-compose -f docker-compose.evolution.yml logs -f roundtable-scheduler

logs-web:
	docker-compose -f docker-compose.evolution.yml logs -f web-ui

# Test GPU access
gpu-test:
	@echo "ğŸ® Testing GPU Access..."
	@echo "Host GPU Status:"
	nvidia-smi || echo "âŒ No GPU on host"
	@echo ""
	@echo "Container GPU Access:"
	docker run --rm --gpus all nvidia/cuda:12.2-runtime nvidia-smi || echo "âŒ No GPU access in containers"

# Show evolution system status
evolution-status:
	@echo "ğŸª´ Tamagotchi Evolution Status:"
	@echo ""
	@echo "ğŸ“ Jobs Queue:"
	@ls -la jobs/queue/ 2>/dev/null | wc -l || echo "0"
	@echo ""
	@echo "ğŸ§¬ LoRA Adapters:"
	@ls -la lora_adapters/ 2>/dev/null | wc -l || echo "0"
	@echo ""
	@echo "ğŸ“Š Performance History:"
	@wc -l performance_history.jsonl 2>/dev/null || echo "0 entries"
	@echo ""
	@echo "ğŸ” Evolution Checksums:"
	@wc -l evolution_checksums.txt 2>/dev/null || echo "0 entries"

# Crawler and Feeder Management Commands

# Check crawler system status
crawler-status:
	@echo "ğŸ•·ï¸ Crawler System Status:"
	@echo ""
	@echo "ğŸ” Crawler Service:"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		python3 -c "import os; print('âœ… Crawler enabled' if os.getenv('CRAWLER_ENABLED', 'true') == 'true' else 'âŒ Crawler disabled')" 2>/dev/null || echo "âŒ Crawler service unreachable"
	@echo ""
	@echo "ğŸ“Š Last Crawler Run:"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		ls -la logs/crawler_last_run.log 2>/dev/null | tail -1 || echo "No crawler logs found"
	@echo ""
	@echo "ğŸ¯ Challenge Discovery Rate:"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		python3 -c "import json; f=open('logs/feeding_history.jsonl', 'r'); lines=f.readlines()[-10:]; print(f'Last 10 discoveries: {len(lines)} challenges')" 2>/dev/null || echo "No feeding history"

# Run crawler immediately
crawler-run:
	@echo "ğŸš€ Running Crawler Immediately..."
	docker-compose -f docker-compose.evolution.yml exec roundtable-scheduler \
		python3 scripts/auto_crawler.py
	@echo "âœ… Crawler run completed!"

# View crawler statistics
crawler-stats:
	@echo "ğŸ“ˆ Crawler Statistics:"
	@echo ""
	@echo "ğŸ”¢ Total Challenges Discovered:"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		wc -l logs/feeding_history.jsonl 2>/dev/null || echo "0"
	@echo ""
	@echo "ğŸ“Š Discovery Rate (Last 24h):"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		python3 -c "
import json, datetime
try:
    with open('logs/feeding_history.jsonl', 'r') as f:
        lines = f.readlines()[-100:]  # Last 100 entries
    recent = [l for l in lines if 'timestamp' in l]
    print(f'Recent discoveries: {len(recent)} challenges')
except: print('No crawler statistics available')
" 2>/dev/null || echo "Statistics unavailable"
	@echo ""
	@echo "ğŸ¯ Domain Distribution:"
	@curl -s http://localhost:8000/api/challenge-queue/stats 2>/dev/null | python3 -m json.tool || echo "API unreachable"

# Check auto-feeder status
feeder-status:
	@echo "ğŸ½ï¸ Auto-Feeder Status:"
	@echo ""
	@echo "âš¡ Feeder Service:"
	@docker-compose -f docker-compose.evolution.yml exec -T roundtable-scheduler \
		python3 scripts/auto_feeder_daemon.py --status 2>/dev/null || echo "âŒ Feeder service unreachable"
	@echo ""
	@echo "ğŸ“Š Queue Size:"
	@curl -s http://localhost:8000/api/challenge-queue/status 2>/dev/null || echo "Queue status unavailable"

# Force immediate feeding
feeder-run:
	@echo "ğŸš€ Running Auto-Feeder Immediately..."
	docker-compose -f docker-compose.evolution.yml exec roundtable-scheduler \
		python3 scripts/auto_feeder_daemon.py --feed-now
	@echo "âœ… Feeding completed!"

# Show challenge queue status
challenge-queue:
	@echo "ğŸ“‹ Challenge Queue Status:"
	@echo ""
	@echo "ğŸ”¢ Queue Size:"
	@ls -la jobs/queue/ 2>/dev/null | wc -l || echo "0"
	@echo ""
	@echo "ğŸ¯ Recent Jobs:"
	@ls -t jobs/queue/ 2>/dev/null | head -5 || echo "No jobs in queue"
	@echo ""
	@echo "ğŸ“Š Queue Metrics:"
	@curl -s http://localhost:8000/api/challenge-queue/metrics 2>/dev/null || echo "Queue metrics unavailable"

# Clean up Docker resources
clean:
	@echo "ğŸ§¹ Cleaning Docker Resources..."
	docker-compose -f docker-compose.evolution.yml down -v --remove-orphans
	docker system prune -f
	docker volume prune -f
	@echo "âœ… Cleanup complete!"

# Validate Docker Compose configuration
validate:
	@echo "âœ… Validating Docker Compose Configuration..."
	docker-compose -f docker-compose.evolution.yml config

# Create production volumes
create-volumes:
	@echo "ğŸ“ Creating Production Volumes..."
	sudo mkdir -p /var/lib/tamagotchi/prometheus
	sudo mkdir -p /var/lib/tamagotchi/grafana
	sudo chown -R 65534:65534 /var/lib/tamagotchi/prometheus
	sudo chown -R 472:472 /var/lib/tamagotchi/grafana
	@echo "âœ… Volumes created!"

# Push to evolution-main branch (clean)
push-evolution:
	@echo "ğŸš€ Preparing Clean Push to Evolution-Main..."
	@echo ""
	@echo "ğŸ“‹ Files to be committed:"
	@git status --porcelain | grep -E "(docker/|docker-compose|Makefile|requirements.txt|\.gitignore|README.md|DOCKER_|EVOLUTION_)" || echo "No evolution files to commit"
	@echo ""
	@read -p "Continue with push? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo ""
	@echo "ğŸ§¹ Copying evolution .gitignore..."
	cp .gitignore.evolution .gitignore
	@echo "ğŸ“¦ Adding essential files only..."
	git add docker/
	git add docker-compose.evolution.yml
	git add Makefile.evolution
	git add requirements.txt
	git add .gitignore
	git add README.md
	git add DOCKER_DEPLOYMENT_CHECKLIST.md
	git add EVOLUTION_CHECKLIST.md
	git add web_ui.py
	git add web_ui_security_patch.py
	git add emotional_roundtable_protocol.py
	git add real_emotional_a2a_server.py
	git add real_emotional_a2a_orchestrator.py
	git add v11_emotional_swarm.py
	git add logic_god_v11_production_server.py
	git add evolve_with_emotions.py
	git add scripts/monitor_evolution.py
	git add scripts/auto_crawler.py
	git add scripts/auto_feeder_daemon.py
	git add scripts/evolution_telegram_notifier.py
	git add trainer/trainer_worker.py
	@echo "ğŸ’¾ Committing evolution containerization..."
	git commit -m "ğŸ³ğŸ­ğŸª´ Production Docker Containerization for Evolution-Main

- Enhanced Docker Compose with production security
- INT4 LLama.cpp optimization in swarm-api
- Horizontal scaling ready trainer worker
- CPU-only emotional round-table scheduler
- External TSDB volumes for Prometheus/Grafana
- Lightweight Alpine telegram notifier
- Production Web UI with security patches
- Health checks and metrics endpoints
- Read-only containers with non-root users
- Clean .gitignore for production focus

Ready for: make build && make up && make health"
	@echo "ğŸš€ Pushing to evolution-main..."
	git push origin evolution-main1:evolution-main --force-with-lease
	@echo "âœ… Evolution containerization deployed!"

# Development helpers
dev-up:
	docker-compose -f docker-compose.yml up -d

dev-down:
	docker-compose -f docker-compose.yml down

# Production deployment
prod-deploy: validate create-volumes build up health
	@echo "ğŸ‰ Production Evolution Stack Deployed!"
	@echo "ğŸŒ Access points:"
	@echo "  - Web UI: http://localhost:5000"
	@echo "  - Grafana: http://localhost:3000"
	@echo "  - Prometheus: http://localhost:9091"
	@echo "  - API: http://localhost:8000"

# Emergency procedures
emergency-stop:
	@echo "ğŸš¨ Emergency Stop - Killing All Containers..."
	docker kill $$(docker ps -q) 2>/dev/null || true
	docker-compose -f docker-compose.evolution.yml down --remove-orphans

emergency-rollback:
	@echo "ğŸ”„ Emergency Rollback..."
	git checkout evolution-main^
	make build
	make up
	@echo "âœ… Rollback complete!"

# Monitoring shortcuts
watch-logs:
	watch -n 2 'docker-compose -f docker-compose.evolution.yml logs --tail=20'

watch-status:
	watch -n 5 'make status'

# Crawler monitoring shortcuts
watch-crawler:
	watch -n 10 'make crawler-stats'

watch-queue:
	watch -n 5 'make challenge-queue'

# Performance testing
perf-test:
	@echo "âš¡ Running Performance Tests..."
	@echo "ğŸ§  Testing Swarm API Response Time:"
	@time curl -s http://localhost:8000/health > /dev/null
	@echo "ğŸ­ Testing Emotional Consensus:"
	@time curl -s -X POST http://localhost:8000/emotional-consensus -H "Content-Type: application/json" -d '{"task": "Performance test"}' > /dev/null

# Crawler performance testing
crawler-perf-test:
	@echo "ğŸ•·ï¸ Testing Crawler Performance..."
	@echo "ğŸ“Š Running discovery test..."
	@time docker-compose -f docker-compose.evolution.yml exec roundtable-scheduler \
		python3 scripts/auto_crawler.py --domain=math --count=5
	@echo "ğŸ½ï¸ Testing feeder performance..."
	@time docker-compose -f docker-compose.evolution.yml exec roundtable-scheduler \
		python3 scripts/auto_feeder_daemon.py --feed-now

# Security audit
security-audit:
	@echo "ğŸ”’ Security Audit:"
	@echo "ğŸ“Š Container Security:"
	docker-compose -f docker-compose.evolution.yml exec swarm-api whoami
	docker-compose -f docker-compose.evolution.yml exec trainer whoami
	docker-compose -f docker-compose.evolution.yml exec roundtable-scheduler whoami
	@echo "ğŸ” File Permissions:"
	docker-compose -f docker-compose.evolution.yml exec swarm-api ls -la /app
	@echo "ğŸ›¡ï¸ Security Options:"
	docker inspect $$(docker-compose -f docker-compose.evolution.yml ps -q) | grep -A 5 "SecurityOpt" 