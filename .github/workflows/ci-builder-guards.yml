name: Builder Auto-Merge Guards

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  PROMETHEUS_URL: http://localhost:9090
  PYTHONPATH: .

jobs:
  security-arch-guards:
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.security-check.outputs.passed }}
      arch-passed: ${{ steps.arch-check.outputs.passed }}
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests prometheus-client
    
    - name: Security CVE Guard Check
      id: security-check
      run: |
        echo "ğŸ›¡ï¸ Checking critical_cve_total metric..."
        
        # Query Prometheus for critical CVE count
        response=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=critical_cve_total" || echo "error")
        
        if echo "$response" | grep -q "error"; then
          echo "âš ï¸ Prometheus not available - allowing merge (dev mode)"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          cve_count=$(echo "$response" | jq -r '.data.result[0].value[1] // "0"')
          echo "Critical CVEs found: $cve_count"
          
          if [ "$cve_count" -gt 0 ]; then
            echo "âŒ BLOCKING MERGE: critical_cve_total = $cve_count (must be 0)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Security guard passed: critical_cve_total = 0"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Architecture Diff Guard Check
      id: arch-check
      run: |
        echo "ğŸ—ï¸ Checking arch_diff_missing_total metric..."
        
        # Query Prometheus for architecture diff count
        response=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=arch_diff_missing_total" || echo "error")
        
        if echo "$response" | grep -q "error"; then
          echo "âš ï¸ Prometheus not available - allowing merge (dev mode)"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          diff_count=$(echo "$response" | jq -r '.data.result[0].value[1] // "0"')
          echo "Architecture diffs found: $diff_count"
          
          if [ "$diff_count" -gt 0 ]; then
            echo "âŒ BLOCKING MERGE: arch_diff_missing_total = $diff_count (must be 0)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Architecture guard passed: arch_diff_missing_total = 0"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Guardian Integration Check
      if: steps.security-check.outputs.passed == 'true' && steps.arch-check.outputs.passed == 'true'
      run: |
        echo "ğŸ›¡ï¸ All Guardian checks passed - safe for autonomous merge"
        echo "âœ… Security: critical_cve_total = 0"
        echo "âœ… Architecture: arch_diff_missing_total = 0"
        echo "ğŸš€ Builder auto-merge safeguards satisfied"

  merge-gate:
    runs-on: ubuntu-latest
    needs: security-arch-guards
    if: always()
    
    steps:
    - name: Check merge eligibility
      run: |
        if [ "${{ needs.security-arch-guards.outputs.security-passed }}" != "true" ] || [ "${{ needs.security-arch-guards.outputs.arch-passed }}" != "true" ]; then
          echo "âŒ MERGE BLOCKED by Guardian safeguards"
          echo "Security passed: ${{ needs.security-arch-guards.outputs.security-passed }}"
          echo "Architecture passed: ${{ needs.security-arch-guards.outputs.arch-passed }}"
          exit 1
        else
          echo "âœ… All Guardian safeguards passed - merge authorized"
        fi
    
    - name: Add merge-safe label
      if: success()
      uses: actions-ecosystem/action-add-labels@v1
      with:
        labels: merge-safe, guardian-approved 